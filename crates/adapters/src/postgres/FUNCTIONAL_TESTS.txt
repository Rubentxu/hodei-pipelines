# Pipeline Execution Functional Tests

## ğŸ¯ Tests Funcionales Reales con Testcontainers

Estos son **tests funcionales reales** que utilizan PostgreSQL y Testcontainers. **NO son mocks ni simulaciones**.

## ğŸ“‹ Tests Implementados

### Test 1: Pipeline Creation and Persistence (TDD Red â†’ Green)
Verifica que:
- Los pipelines se pueden crear con mÃºltiples steps
- Los pipelines se persisten correctamente en PostgreSQL
- Los steps con dependencias se guardan y recuperan correctamente

### Test 2: Pipeline Execution Orchestration (TDD Red â†’ Green)
Verifica que:
- El PipelineExecutionOrchestrator puede ejecutar pipelines
- Las ejecuciones se crean y persisten en base de datos
- El sistema de eventos funciona correctamente

### Test 3: Pipeline with Dependencies (TDD Red â†’ Green)
Verifica que:
- Pipelines con dependencias complejas funcionan
- Las dependencias entre steps se respetan
- El orden de ejecuciÃ³n se calcula correctamente

### Test 4: Pipeline Variables (TDD Red â†’ Green)
Verifica que:
- Variables de pipeline se persisten correctamente
- Variables se propagan a los jobs
- Soporte multi-tenant funciona

## ğŸš€ CÃ³mo Ejecutar

```bash
# Ejecutar TODOS los tests funcionales
cargo test --features integration --lib postgres::functional_tests

# Ejecutar un test especÃ­fico
cargo test --features integration --lib postgres::functional_tests::test_pipeline_creation_and_persistence
```

## âš™ï¸ CaracterÃ­sticas

### âœ… Auto-gestionables
- **NO requiere levantar PostgreSQL manualmente**
- Testcontainers crea y destruye automÃ¡ticamente los contenedores
- Cada test tiene su propia base de datos limpia

### âœ… PostgreSQL Real
- Usan **PostgreSQL real**, no SQLite ni mocks
- Conexiones reales con sqlx
- Transacciones y constraints reales

### âœ… TDD (Test-Driven Development)
- Tests escritos **ANTES** de implementar funcionalidad
- Rojo â†’ Verde â†’ Refactor
- Cada test es una especificaciÃ³n de comportamiento

### âœ… Aislados
- Cada test usa su propia base de datos
- Clean up automÃ¡tico entre tests
- Sin efectos secundarios

## ğŸ“¦ Dependencias

```toml
[features]
integration = ["testcontainers", "sqlx/runtime-tokio-rustls", "hodei-core/sqlx"]
```

Requiere:
- `testcontainers` - Para levantar PostgreSQL automÃ¡ticamente
- `sqlx` - Cliente PostgreSQL con async/await
- Feature `integration` habilitada

## ğŸ”§ ConfiguraciÃ³n

### PostgreSQL
- Usuario: `postgres`
- Password: `postgres`
- Base de datos: `postgres`
- Puerto: Aleatorio (asignado por Testcontainers)

### Variables de entorno (opcionales)
```bash
# Usar PostgreSQL externo en lugar de Testcontainers
export TEST_DATABASE_URL="postgresql://postgres:postgres@localhost:5432/hodei_test"
```

## ğŸ“Š Cobertura

Los tests cubren:
- âœ… CreaciÃ³n y persistencia de pipelines
- âœ… OrquestaciÃ³n de ejecuciÃ³n de pipelines
- âœ… Dependencias entre steps
- âœ… Variables y entornos
- âœ… Multi-tenancy
- âœ… Esquemas de base de datos
- âœ… Repositorios PostgreSQL (Job, Pipeline, PipelineExecution)

## ğŸš§ En Desarrollo

PrÃ³ximos tests:
- [ ] Pipeline execution con jobs reales
- [ ] CancelaciÃ³n de ejecuciones
- [ ] Reintentos y manejo de errores
- [ ] Concurrencia y paralelizaciÃ³n
- [ ] MÃ©tricas y monitoreo
- [ ] Rollback de ejecuciones fallidas

## ğŸ“ MetodologÃ­a

Estos tests siguen **TDD estricto**:
1. **RED**: Test que falla (especifica comportamiento esperado)
2. **GREEN**: ImplementaciÃ³n mÃ­nima para pasar el test
3. **REFACTOR**: Mejorar cÃ³digo manteniendo tests verdes

**NO son integration tests tradicionales** - son **unit tests funcionales** que prueban comportamiento real del sistema usando componentes reales.
