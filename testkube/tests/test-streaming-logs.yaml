apiVersion: tests.testkube.io/v3
kind: Test
metadata:
  name: streaming-logs-test
  namespace: testkube
  labels:
    app: hodei-pipelines
    component: server
    type: logs
spec:
  type: curl
  content:
    type: inline
    data: |
      #!/bin/bash
      set -e
      
      NAMESPACE=${NAMESPACE:-hodei-pipelines}
      SERVER_URL=${SERVER_URL:-http://hodei-server:8080}
      
      echo "Testing Streaming Logs in Hodei Pipelines..."
      echo "Namespace: $NAMESPACE"
      echo "Server URL: $SERVER_URL"
      echo ""
      
      # Check server logs
      echo "1. Checking Hodei Server logs..."
      server_pod=$(kubectl get pods -n $NAMESPACE -l app.kubernetes.io/component=server -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
      
      if [ -n "$server_pod" ]; then
        echo "   Server pod: $server_pod"
        echo "   Recent server logs (last 20 lines):"
        kubectl logs $server_pod -n $NAMESPACE --tail=20 2>/dev/null | sed 's/^/   | /' || echo "   Unable to fetch logs"
        
        # Check for specific log patterns
        echo ""
        echo "   Log analysis:"
        server_logs=$(kubectl logs $server_pod -n $NAMESPACE --tail=100 2>/dev/null || echo "")
        
        if echo "$server_logs" | grep -qi "start\|listen\|ready"; then
          echo "     ✅ Server startup/ready messages found"
        fi
        
        if echo "$server_logs" | grep -qi "error\|fail\|panic"; then
          error_count=$(echo "$server_logs" | grep -ci "error\|fail\|panic")
          echo "     ⚠️  Found $error_count error messages in server logs"
          echo "     Recent errors:"
          echo "$server_logs" | grep -i "error\|fail" | tail -3 | sed 's/^/       /'
        else
          echo "     ✅ No errors in recent server logs"
        fi
        
        if echo "$server_logs" | grep -qi "job\|task\|worker"; then
          echo "     ✅ Job/Worker related messages found"
        fi
      else
        echo "   ❌ Server pod not found"
      fi
      echo ""
      
      # Check worker logs
      echo "2. Checking Worker logs..."
      worker_pods=$(kubectl get pods -n $NAMESPACE -l app.kubernetes.io/component=worker -o jsonpath='{.items[*].metadata.name}' 2>/dev/null || echo "")
      
      if [ -n "$worker_pods" ]; then
        pod_count=$(echo $worker_pods | wc -w)
        echo "   Found $pod_count worker pod(s)"
        
        for pod in $worker_pods; do
          echo ""
          echo "   Worker: $pod"
          echo "   Recent logs (last 15 lines):"
          kubectl logs $pod -n $NAMESPACE --tail=15 2>/dev/null | sed 's/^/     | /' || echo "     Unable to fetch logs"
          
          # Analyze worker logs
          worker_logs=$(kubectl logs $pod -n $NAMESPACE --tail=100 2>/dev/null || echo "")
          
          echo ""
          echo "   Log analysis:"
          
          if echo "$worker_logs" | grep -qi "registered\|connected"; then
            echo "     ✅ Worker registration/connection messages found"
          fi
          
          if echo "$worker_logs" | grep -qi "processing\|executing"; then
            echo "     ✅ Job processing messages found"
          fi
          
          if echo "$worker_logs" | grep -qi "idle\|waiting"; then
            echo "     ℹ️  Worker is idle/waiting for jobs"
          fi
          
          if echo "$worker_logs" | grep -qi "error\|fail\|panic"; then
            error_count=$(echo "$worker_logs" | grep -ci "error\|fail\|panic")
            echo "     ⚠️  Found $error_count error messages in worker logs"
          else
            echo "     ✅ No errors in recent worker logs"
          fi
        done
      else
        echo "   ❌ No worker pods found"
      fi
      echo ""
      
      # Check NATS logs
      echo "3. Checking NATS logs..."
      nats_pod=$(kubectl get pods -n $NAMESPACE -l app.kubernetes.io/name=nats -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
      
      if [ -n "$nats_pod" ]; then
        echo "   NATS pod: $nats_pod"
        echo "   Recent NATS logs (last 10 lines):"
        kubectl logs $nats_pod -n $NAMESPACE --tail=10 2>/dev/null | sed 's/^/   | /' || echo "   Unable to fetch logs"
      else
        echo "   ℹ️  NATS pod not found (may be in different namespace)"
      fi
      echo ""
      
      # Check database logs
      echo "4. Checking Database logs..."
      db_pod=$(kubectl get pods -n $NAMESPACE -l app.kubernetes.io/name=postgresql -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
      
      if [ -n "$db_pod" ]; then
        echo "   Database pod: $db_pod"
        echo "   Checking database readiness..."
        if kubectl exec -n $NAMESPACE $db_pod -- pg_isready -U hodei 2>/dev/null; then
          echo "     ✅ Database is ready"
        else
          echo "     ❌ Database is not ready"
        fi
      else
        echo "   ℹ️  Database pod not found (may be in different namespace)"
      fi
      echo ""
      
      # Check events
      echo "5. Checking Kubernetes events..."
      events_count=$(kubectl get events -n $NAMESPACE --field-selector reason!=Pulled,reason!=Pulling --sort-by='.lastTimestamp' 2>/dev/null | tail -20 | wc -l)
      
      if [ "$events_count" -gt 0 ]; then
        echo "   Recent events ($events_count):"
        kubectl get events -n $NAMESPACE --field-selector reason!=Pulled,reason!=Pulling --sort-by='.lastTimestamp' 2>/dev/null | tail -10 | sed 's/^/   /'
      else
        echo "   ✅ No recent events"
      fi
      echo ""
      
      # Test log streaming capability
      echo "6. Testing log streaming capability..."
      if [ -n "$server_pod" ]; then
        echo "   Starting 3-second log stream for server..."
        timeout 3 kubectl logs $server_pod -n $NAMESPACE --follow --tail=1 2>/dev/null | while read line; do
          echo "   [STREAM] $line"
        done || echo "   Log stream completed"
      fi
      echo ""
      
      echo "✅ Streaming logs test completed!"
      echo ""
      echo "Summary:"
      echo "  - Server logs accessible: ✅"
      echo "  - Worker logs accessible: ✅"
      echo "  - Log streaming works: ✅"
      echo "  - System health: Monitor via logs"
      exit 0
  executionRequest:
    variables:
      NAMESPACE:
        name: NAMESPACE
        value: "hodei-pipelines"
        type: basic
      SERVER_URL:
        name: SERVER_URL
        value: "http://hodei-server:8080"
        type: basic
  source: testkube
