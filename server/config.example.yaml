# Hodei Pipelines Server Configuration Example
# Copy this file to config.yaml and modify as needed

# Server Configuration
server:
  port: 8080
  grpc_port: 9090
  host: "0.0.0.0"

  # CORS settings
  cors:
    allowed_origins:
      - "http://localhost:3000"
      - "http://localhost:8080"
    allowed_methods:
      - GET
      - POST
      - PUT
      - DELETE
    allowed_headers:
      - "Content-Type"
      - "Authorization"

# Resource Pool Configuration
resource_pools:
  enabled: true
  default_pool_type: static

  # Define resource pools
  pools:
    - id: "pool-default"
      name: "Default Pool"
      type: "static"
      min_size: 2
      max_size: 20
      auto_scaling_enabled: true
      provider: "docker"

      # Scaling policies
      scaling_policies:
        - name: "cpu-scaling"
          trigger: "cpu_utilization > 80"
          action: "scale_up"
          cooldown: "5m"
        - name: "memory-scaling"
          trigger: "memory_utilization > 85"
          action: "scale_up"
          cooldown: "5m"

      # Quota configuration
      quotas:
        max_concurrent_jobs: 100
        max_jobs_per_tenant: 50

    - id: "pool-gpu"
      name: "GPU Pool"
      type: "dynamic"
      min_size: 1
      max_size: 10
      auto_scaling_enabled: true
      provider: "kubernetes"

      # GPU-specific settings
      resources:
        cpu_m: 8000
        memory_mb: 32768
        gpu: 1

      scaling_policies:
        - name: "gpu-demand"
          trigger: "queue_depth > 10"
          action: "scale_up"
          cooldown: "10m"

    - id: "pool-high-mem"
      name: "High Memory Pool"
      type: "static"
      min_size: 2
      max_size: 15
      auto_scaling_enabled: false
      provider: "docker"

      resources:
        cpu_m: 4000
        memory_mb: 65536

# Multi-Tenancy Configuration
multi_tenancy:
  enabled: true

  # Default tenant quota
  default_tenant_quota:
    cpu_m: 4000
    memory_mb: 8192
    max_concurrent_jobs: 10

  # Quota enforcement settings
  quota_enforcement:
    strict_mode: true
    violation_policy: "reject" # Options: reject, queue, burst
    check_interval_ms: 1000

  # Tenant isolation
  isolation:
    use_namespaces: true
    network_isolation: true
    storage_isolation: true

# Burst Capacity Management
burst_capacity:
  enabled: true

  # Burst capacity policies
  default_policy:
    max_overage_percentage: 150 # 150% of quota
    burst_duration_minutes: 60
    require_approval: false

  # Advanced burst settings
  max_concurrent_burst_sessions: 100
  burst_cooldown_minutes: 30

  # Approval workflow (if required)
  approval:
    auto_approve_threshold: 200 # Auto-approve if < 200% of quota
    require_manual_approval: true
    approvers:
      - "admin@company.com"
      - "ops@company.com"

# Job Scheduling Configuration
scheduling:
  # Scheduler settings
  scheduler_interval_ms: 100
  max_queue_size: 10000
  worker_heartbeat_timeout_ms: 30000

  # Weighted Fair Queuing settings
  fair_queuing:
    enabled: true
    weight_strategy: "quota_based" # Options: quota_based, billing_tier, custom
    fairness_window_minutes: 60
    starvation_prevention: true
    starvation_threshold_minutes: 30

  # SLA tracking
  sla_tracking:
    enabled: true
    default_sla_hours: 24
    priority_boost_threshold_minutes: 30
    priority_boost_factor: 2.0

  # Queue prioritization
  queue_prioritization:
    strategies:
      - "fifo"
      - "priority"
      - "sla"
    default_strategy: "weighted_fair"

# Cost Tracking Configuration
cost_tracking:
  enabled: true

  # Cost attribution
  track_by_tenant: true
  track_by_job: true
  track_by_pool: true

  # Cost calculation
  hourly_rate_cpu: 0.05 # $0.05 per vCPU per hour
  hourly_rate_memory_gb: 0.01 # $0.01 per GB per hour
  hourly_rate_gpu: 2.50 # $2.50 per GPU per hour

  # Cost aggregation
  aggregation_interval_minutes: 15
  retention_days: 90

  # Budget alerts
  budget_alerts:
    enabled: true
    warning_threshold: 0.80 # 80% of budget
    critical_threshold: 0.95 # 95% of budget

# Worker Management
worker_management:
  # Worker lifecycle
  idle_timeout_minutes: 30
  cleanup_interval_minutes: 10
  pre_warm_enabled: true
  pre_warm_target: 0.2 # 20% of max pool size

  # Worker reuse
  reuse_enabled: true
  max_reuse_count: 10
  health_check_interval_seconds: 30

  # Provisioning settings
  max_concurrent_provisioning: 5
  provisioning_timeout_minutes: 10
  retry_failed_provisioning: true
  max_retry_attempts: 3

# Auto-Scaling Configuration
auto_scaling:
  enabled: true

  # Global settings
  default_cooldown_minutes: 5
  scale_down_delay_minutes: 10

  # Metrics-based scaling
  metrics:
    - name: "cpu_utilization"
      threshold_up: 80
      threshold_down: 30
    - name: "memory_utilization"
      threshold_up: 85
      threshold_down: 40
    - name: "queue_depth"
      threshold_up: 50
      threshold_down: 5
    - name: "job_wait_time"
      threshold_up: 300 # 5 minutes
      threshold_down: 60 # 1 minute

  # Predictive scaling (optional)
  predictive_scaling:
    enabled: false
    prediction_window_minutes: 60
    min_history_hours: 24

# Metrics and Observability
metrics:
  prometheus:
    enabled: true
    port: 9091
    path: "/metrics"
    histogram_buckets:
      - 0.1
      - 0.25
      - 0.5
      - 1.0
      - 2.5
      - 5.0
      - 10.0

  # Custom metrics
  custom_metrics:
    enabled: true
    collection_interval_seconds: 15

observability:
  # Logging
  logging:
    level: "info" # Options: trace, debug, info, warn, error
    format: "json"
    output: "stdout"

    # Structured logging
    include_trace_id: true
    include_span_id: true

  # Tracing
  tracing:
    enabled: true
    jaeger_endpoint: "http://jaeger:14268/api/traces"
    sampling_rate: 0.1

  # Grafana Integration
  grafana:
    enabled: true
    url: "http://grafana:3000"
    api_key: "${GRAFANA_API_KEY}"
    dashboards_dir: "/etc/hodei/dashboards"
    auto_import: true

  # Alerting
  alerting:
    enabled: true
    prometheus_alerts_dir: "/etc/hodei/alerts"
    alertmanager_url: "http://alertmanager:9093"

    # Notification channels
    slack:
      enabled: true
      webhook_url: "${SLACK_WEBHOOK_URL}"
      channel: "#ops-alerts"

    email:
      enabled: true
      smtp_server: "smtp.company.com"
      smtp_port: 587
      username: "${SMTP_USERNAME}"
      password: "${SMTP_PASSWORD}"
      from_address: "hodei-alerts@company.com"
      to_addresses:
        - "ops@company.com"
        - "dev@company.com"

# Security Configuration
security:
  # Authentication
  jwt:
    secret: "${JWT_SECRET}"
    expiration_hours: 24
    issuer: "hodei-pipelines"

  # Rate limiting
  rate_limiting:
    enabled: true
    requests_per_minute: 1000
    burst_size: 100

  # TLS/SSL
  tls:
    enabled: false
    cert_file: "/etc/ssl/certs/hodei.crt"
    key_file: "/etc/ssl/private/hodei.key"

# Database Configuration
database:
  # In-memory (default, for development)
  type: "inmemory"

  # PostgreSQL (for production)
  # type: "postgres"
  # url: "${DATABASE_URL}"
  # max_connections: 20
  # connection_timeout_seconds: 30

  # Migration settings
  migrations:
    auto_migrate: true
    migrations_dir: "migrations"

# gRPC Configuration
grpc:
  # Server settings
  server:
    port: 9090
    max_concurrent_streams: 100
    max_receive_message_size: 10485760 # 10MB
    max_send_message_size: 10485760 # 10MB

  # Client settings
  client:
    timeout_seconds: 30
    retry_attempts: 3
    retry_delay_seconds: 1

# Event Bus Configuration
event_bus:
  # Event bus type: nats (default) or inmemory (for testing only)
  # NOTE: NATS JetStream is now the default for production use
  bus_type: "nats"

  # InMemory bus settings (only used if bus_type is inmemory)
  inmemory_capacity: 10000

  # NATS JetStream configuration (used when bus_type is nats)
  nats:
    url: "nats://nats:4222"
    connection_timeout_ms: 5000

# Feature Flags
feature_flags:
  multi_tenancy: true
  cost_tracking: true
  auto_scaling: true
  burst_capacity: true
  weighted_fair_queuing: true
  sla_tracking: true
  worker_reuse: true
  grafana_dashboards: true
  prometheus_alerts: true
  cost_optimization: true

# Environment-specific settings
development:
  log_level: "debug"
  metrics_enabled: true
  tracing_enabled: false

production:
  log_level: "info"
  metrics_enabled: true
  tracing_enabled: true
  tls_enabled: true

# Health Checks
health:
  enabled: true
  port: 8081
  path: "/health"

  checks:
    - name: "database"
      type: "database"
      timeout_seconds: 5
    - name: "external_services"
      type: "http"
      url: "http://external-service:8080/health"
      timeout_seconds: 10
    - name: "worker_pools"
      type: "custom"
      timeout_seconds: 15

# Environment Variables to Set
# =================================
# HODEI_PORT=8080
# HODEI_GRPC_PORT=9090
# HODEI_JWT_SECRET=your-jwt-secret
# HODEI_DATABASE_URL=postgresql://user:pass@host:5432/db
# HODEI_GRAFANA_API_KEY=your-grafana-api-key
# HODEI_SLACK_WEBHOOK_URL=https://hooks.slack.com/...
# HODEI_SMTP_USERNAME=your-smtp-username
# HODEI_SMTP_PASSWORD=your-smtp-password
