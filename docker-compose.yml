# ========================================
# Docker Compose para Hodei Pipelines Server
# Entorno Productivo con API REST y Swagger UI
# ========================================

services:
  # ========================================
  # Base de Datos PostgreSQL
  # ========================================
  postgres:
    image: postgres:16-alpine
    container_name: hodei-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: hodei
      POSTGRES_PASSWORD: hodei_password_2024
      POSTGRES_DB: hodei_jobs
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./docker/postgres/init:/docker-entrypoint-initdb.d
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U hodei"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - hodei-network

  # ========================================
  # Hodei Server (API Principal)
  # ========================================
  hodei-server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: hodei-server
    restart: unless-stopped
    environment:
      # Configuración del servidor
      HODEI_PORT: 8080
      HODEI_GRPC_PORT: 50051

      # Configuración de base de datos
      DATABASE_URL: postgresql://hodei:hodei_password_2024@postgres:5432/hodei_jobs

      # Configuración de seguridad
      HODEI_JWT_SECRET: super_secret_jwt_key_change_in_production_2024
      HODEI_TLS_ENABLED: "false"

      # Configuración de logging
      RUST_LOG: info
      RUST_BACKTRACE: 1

      # Configuración de recursos
      MAX_CONCURRENT_JOBS: 100
      SCHEDULING_INTERVAL_MS: 100
      WORKER_HEARTBEAT_TIMEOUT_MS: 30000
    ports:
      # API REST
      - "8080:8080"
      # gRPC API
      - "50051:50051"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    volumes:
      - ./logs:/app/logs
    networks:
      - hodei-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.hodei-api.rule=Host('api.hodei.local')"
      - "traefik.http.routers.hodei-api.tls=true"
      - "traefik.http.services.hodei-server.loadbalancer.server.port=8080"

  # ========================================
  # Worker 01 - Nodo de ejecución de jobs
  # ========================================
  worker-01:
    build:
      context: .
      dockerfile: crates/hwp-agent/Dockerfile
    container_name: hodei-worker-01
    restart: unless-stopped
    environment:
      WORKER_ID: worker-01
      SERVER_URL: http://hodei-server:8080
      GRPC_SERVER_URL: http://hodei-server:50051
      WORKER_NAME: worker-01
      WORKER_CPU_CORES: 4
      WORKER_MEMORY_GB: 8
      RUST_LOG: info
    depends_on:
      hodei-server:
        condition: service_healthy
    networks:
      - hodei-network
    profiles:
      - workers

  # ========================================
  # Worker 02 - Nodo de ejecución de jobs
  # ========================================
  worker-02:
    build:
      context: .
      dockerfile: crates/hwp-agent/Dockerfile
    container_name: hodei-worker-02
    restart: unless-stopped
    environment:
      WORKER_ID: worker-02
      SERVER_URL: http://hodei-server:8080
      GRPC_SERVER_URL: http://hodei-server:50051
      WORKER_NAME: worker-02
      WORKER_CPU_CORES: 4
      WORKER_MEMORY_GB: 8
      RUST_LOG: info
    depends_on:
      hodei-server:
        condition: service_healthy
    networks:
      - hodei-network
    profiles:
      - workers

  # ========================================
  # Worker 03 - Nodo de ejecución de jobs
  # ========================================
  worker-03:
    build:
      context: .
      dockerfile: crates/hwp-agent/Dockerfile
    container_name: hodei-worker-03
    restart: unless-stopped
    environment:
      WORKER_ID: worker-03
      SERVER_URL: http://hodei-server:8080
      GRPC_SERVER_URL: http://hodei-server:50051
      WORKER_NAME: worker-03
      WORKER_CPU_CORES: 2
      WORKER_MEMORY_GB: 4
      RUST_LOG: info
    depends_on:
      hodei-server:
        condition: service_healthy
    networks:
      - hodei-network
    profiles:
      - workers

# ========================================
# Volumes Persistentes
# ========================================
volumes:
  postgres_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./data/postgres

# ========================================
# Network
# ========================================
networks:
  hodei-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
